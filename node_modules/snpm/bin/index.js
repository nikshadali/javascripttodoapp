#! /usr/bin/env node

const shell = require('shelljs');
const fs = require('fs');
const path = require('path');
const os = require('os');

console.log('Hello, it is a slow npm!\n');

const currentDir = process.cwd();
const commandArgs = process.argv.slice(2);
const moduleName = commandArgs.find((a) => /^[a-zA-Z]/.test(a));

// Check if user wants to install global module
if (commandArgs.indexOf('-g') !== -1) {
  // Install global package
  shell.exec(`npm install ${commandArgs.join(' ')}`);
  console.log(`Congrats! Installing of module: '${moduleName}' is done!`);
} else {
  try {
    // Check if package.json is present
    fs.statSync('./package.json');
    // Get new tmp folder path
    const newDirPath = path.join(os.homedir(), `.snpm-tmp-${Date.now()}`);
    // Execute a set of some bash commands, because I don't know Node JS
    shell.exec([
      `mkdir ${newDirPath}`,
      `cd ${newDirPath}`,
      `cp ${currentDir}/package.json ./package.json`,
      `npm install ${commandArgs.join(' ')}`,
      `rsync -r ./node_modules/* ${currentDir}/node_modules`,
      `cd ${currentDir}`,
      `rm -rf ${newDirPath}`
    ].join(' && '));

    console.log('Congrats! You have new awesome set of npm modules now!');
  } catch(e) {
    console.log(
      'Wow! You are trying to install locale module without package.json file.\n',
      'Try to run npm init before!'
    );
  }
}
